<!--
本程式部分功能使用以下第三方 JavaScript 函式庫，均採 MIT 授權：

SortableJS (MIT License)
https://github.com/SortableJS/Sortable

Chart.js (MIT License)
https://www.chartjs.org/

html2pdf.js (MIT License)
https://github.com/eKoopmans/html2pdf.js

html2canvas (MIT License)
https://github.com/niklasvh/html2canvas

MIT License 條款詳見各專案官方網站。
-->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks 應用程式 (自架後端版)</title>
    <!-- 字型與圖示 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* 主題色與全域樣式 */
        :root {
            --primary-color: #3f51b5; --accent-color: #ff4081; --text-color: #212121;
            --background-color: #f5f5f5; --surface-color: #ffffff; --high-priority-color: #f44336;
            --medium-priority-color: #ff9800; --low-priority-color: #4caf50; --error-color: #d32f2f;
            /* 新增：到期日相關顏色 */
            --overdue-color: #c62828;
            --due-soon-color: #ad6200;
            --status-pending-color: #757575; --status-inprogress-color: #1976d2; --status-completed-color: #43a047;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; overflow: hidden; }
        /* 登入區塊樣式 */
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        #app-container { display: none; flex-direction: column; height: 100vh; }
        .login-card { background: var(--surface-color); padding: 32px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { margin-top: 0; color: var(--primary-color); }
        .login-card .form-group { margin-bottom: 20px; text-align: left; }
        .login-card label { display: block; margin-bottom: 8px; font-weight: 500; }
        .login-card .form-control { width: 100%; padding: 12px; border: 1px solid #bdbdbd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .login-card .error-message { color: var(--error-color); font-size: 0.8rem; margin-top: 4px; min-height: 1.2em; }
        /* App Bar 樣式 */
        .app-bar { background-color: var(--primary-color); color: white; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); height: 64px; flex-shrink: 0; }
        .app-bar h1 { font-size: 1.25rem; font-weight: 500; }
        .app-bar-user-info { display: flex; align-items: center; gap: 16px; }
        #user-email { font-size: 0.9rem; }
        /* 按鈕樣式 */
        .btn { background-color: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .btn:hover { background-color: #e03571; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn.loading { cursor: not-allowed; background-color: #bdbdbd; }
        .btn.loading .mdi-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #logout-btn { background-color: transparent; border: 1px solid white; }
        main { flex-grow: 1; padding: 24px; overflow-y: auto; }
        
        /* 任務卡片樣式 */
        .task-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .task-card { background-color: var(--surface-color); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); padding: 16px; display: flex; flex-direction: column; gap: 8px; transition: box-shadow 0.3s ease; }
        .task-card:active { cursor: grabbing; }

        /* START MODIFICATION: 拖放過程中的視覺回饋樣式 */
        .task-card.sortable-ghost {
            background: #eef2ff;
            border: 2px dashed var(--primary-color);
            opacity: 0.5;
        }
        .task-card.sortable-drag {
            opacity: 0.9;
            transform: rotate(3deg);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }
        .task-card.overdue { border-left-color: var(--overdue-color); }
        .task-card.due-soon { border-left-color: var(--due-soon-color); }
        /* END MODIFICATION */
        .task-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23); }
        .task-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-card-header h3 { margin: 0; font-size: 1.1rem; font-weight: 500; }
        .task-card-actions { display: flex; gap: 8px; }
        .task-card-actions .icon-btn { color: #757575; cursor: pointer; transition: color 0.2s; }
        .task-card-actions .icon-btn:hover { color: var(--primary-color); }
        .task-card p { margin: 0; color: #616161; font-size: 0.9rem; word-break: break-word; }
        .task-card-footer { margin-top: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { padding: 4px 8px; border-radius: 12px; color: white; font-weight: 500; }
        .tag.priority-high { background-color: var(--high-priority-color); }
        .tag.priority-medium { background-color: var(--medium-priority-color); }
        .tag.priority-low { background-color: var(--low-priority-color); }
        .tag.status-pending { background-color: #757575; }
        .tag.status-inprogress { background-color: #1976d2; }
        .tag.status-completed { background-color: #43a047; }
        .creation-date { color: #9e9e9e; }
        /* --- 新增：到期日高亮樣式 --- */
        .task-card.overdue { border-left-color: var(--overdue-color); }
        .task-card.due-soon { border-left-color: var(--due-soon-color); }
        .due-date-display { display: flex; align-items: center; gap: 4px; font-weight: 500; }
        .due-date-display.overdue-text { color: var(--overdue-color); }
        .due-date-display.due-soon-text { color: var(--due-soon-color); }
        /* Modal 樣式 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 11px 15px -7px rgba(0,0,0,0.2), 0 24px 38px 3px rgba(0,0,0,0.14), 0 9px 46px 8px rgba(0,0,0,0.12); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #616161; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #bdbdbd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .form-actions { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 1px solid #e0e0e0; }
        /* Snackbar 樣式 */
        .snackbar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #323232; color: white; padding: 14px 24px; border-radius: 4px; z-index: 2000; transition: bottom 0.5s ease-in-out; }
        .snackbar.show { bottom: 20px; }
        /* 任務分區樣式 */
        .task-section { margin-bottom: 20px; }
        .section-header { background: #fafafa; border: 1px solid #e0e0e0; color: var(--text-color); padding: 10px 16px; cursor: pointer; font-weight: 500; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .section-header:hover { background-color: #f0f0f0; }
        .section-body { padding-top: 16px; }
        .section-body.collapsed { display: none; }
        /* START MODIFICATION: 新增視圖切換器樣式 */
        .view-switcher {
            display: flex;
            background-color: rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 4px;
        }
        .view-switcher .btn {
            background-color: transparent;
            box-shadow: none;
            text-transform: none;
            font-size: 0.95rem;
            padding: 6px 14px;
        }
        .view-switcher .btn:hover {
            background-color: rgba(255,255,255,0.15);
        }
        .view-switcher .btn.active {
            background-color: var(--surface-color);
            color: var(--primary-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        /* END MODIFICATION */
        main { flex-grow: 1; padding: 24px; overflow-y: auto; }
        
        /* START MODIFICATION: 儀表板樣式 */
        #dashboard-view {
            display: none; /* 預設隱藏 */
            padding: 16px;
        }
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 24px;
        }        
        .dashboard-grid {
            display: grid;
            /* 在較寬螢幕上顯示為 2x2 網格 */
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 24px;
        }        
        .chart-container {
            background-color: var(--surface-color);
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }
        .chart-container h2 {
            margin-top: 0;
            margin-bottom: 20px; /* 增加標題與圖表間距 */
            text-align: center;
            color: #333;
            font-weight: 500;
        } 
        /* END MODIFICATION */

        /* 任務描述區域樣式 */
        .task-description {
            margin: 8px 0;
            color: #616161;
            font-size: 0.9rem;
            word-break: break-word;
            line-height: 1.4;
        }

        .task-description b, .task-description strong {
            font-weight: 600;
            color: #424242;
        }

        .task-description i, .task-description em {
            font-style: italic;
        }

        .task-description u {
            text-decoration: underline;
        }

        .task-description ul, .task-description ol {
            margin: 4px 0 4px 20px;
            padding: 0;
        }

        .task-description li {
            margin: 2px 0;
        }

        /* contenteditable 編輯器樣式改進 */
        #description {
            min-height: 80px;
            outline: none;
            padding: 10px;
            line-height: 1.4;
        }

        #description:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }

        #description ul, #description ol {
            margin: 8px 0 8px 20px;
            padding: 0;
        }

        #description li {
            margin: 4px 0;
        }

        .color-btn:hover span {
            box-shadow: 0 0 0 2px var(--primary-color);
        }

        .filter-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
            background-color: var(--surface-color);
            padding: 16px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
            align-items: flex-end;
        }
        .filter-toolbar .form-group {
            margin-bottom: 0;
        }
        .filter-toolbar .form-group.search-group {
            flex: 1 1 220px;
            min-width: 180px;
        }
        .filter-toolbar .form-group.priority-group {
            flex: 0 0 180px;
            min-width: 120px;
        }
        .filter-toolbar .form-group.date-group {
            flex: 0 0 340px;
            min-width: 220px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        @media (max-width: 700px) {
            .filter-toolbar {
                flex-direction: column;
                gap: 8px;
            }
            .filter-toolbar .form-group {
                min-width: 0 !important;
                width: 100% !important;
            }
            .filter-toolbar .form-group.date-group {
                flex-direction: column;
                align-items: flex-start;
                gap: 4px;
            }
        }
               
    </style>
</head>
<body>

    <div id="app-container">
        <header class="app-bar">
            <!-- <h3>我的任務</h3> -->
            <div class="view-switcher">
                <button class="btn active" id="show-tasks-view-btn">任務列表</button>
                <button class="btn" id="show-dashboard-view-btn">儀表板</button>
            </div>
            <div class="app-bar-user-info">
                <span id="user-email"></span>
                <button class="btn" id="add-task-btn"><i class="mdi mdi-plus"></i>新增任務</button>
                <button class="btn" id="export-tasks-btn"><i class="mdi mdi-download"></i>匯出任務</button>
                <button class="btn" id="logout-btn">登出</button>
            </div>
        </header>
        <main id="tasks-view">
            <div class="filter-toolbar">
                <div class="form-group search-group">
                    <input type="search" id="search-input" class="form-control" placeholder="搜尋標題或描述...">
                </div>
                <div class="form-group priority-group">
                    <select id="priority-filter" class="form-control">
                        <option value="all">所有優先級</option>
                        <option value="high">高</option>
                        <option value="medium">中</option>
                        <option value="low">低</option>
                    </select>
                </div>
                <div class="form-group date-group">                    
                    <input type="date" id="created-from" class="form-control"
                        style="width: 125px; min-width: 0; padding: 8px 8px; font-size: 1em; border-radius: 4px;">
                    <span style="font-size:1.2em; color:#888;">~</span>
                    <input type="date" id="created-to" class="form-control"
                        style="width: 125px; min-width: 0; padding: 8px 8px; font-size: 1em; border-radius: 4px;">
                </div>
            </div>
            <div id="task-list-export">
                <!-- 任務分區（可收合） -->
                <div id="task-sections">
                    <div class="task-section">
                        <div class="section-header" data-section="pending">
                            待處理 (Pending) <span id="toggle-pending">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-pending"></div>
                    </div>
                    <div class="task-section">
                        <div class="section-header" data-section="in-progress">
                            進行中 (In Progress) <span id="toggle-in-progress">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-in-progress"></div>
                    </div>
                    <div class="task-section">
                        <div class="section-header" data-section="completed">
                            已完成 (Completed) <span id="toggle-completed">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-completed"></div>
                    </div>
                </div>
            </div>
        </main>
        <main id="dashboard-view">
            <div class="dashboard-grid">
                <div class="chart-container">
                    <h2>任務狀態分佈</h2>
                    <canvas id="status-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>任務優先級分佈</h2>
                    <canvas id="priority-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>最近半年任務建立量</h2>
                    <canvas id="monthly-volume-chart"></canvas>
                </div>
                <div class="chart-container">
                    <h2>最近半年到期任務分析</h2>
                    <canvas id="due-tasks-chart"></canvas>
                </div>
            </div>
        </main>
    </div>

    <!-- 登入/註冊區塊 -->
    <div id="auth-container">
        <div class="login-card">
            <h1>任務管理系統</h1>
            <p>請使用您的 Email 登入或註冊</p>
            <form id="login-form" method="POST">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼 (最少6位數)</label>
                    <input
                        type="password"
                        id="password"
                        class="form-control"
                        required
                        minlength="6"
                        maxlength="64"
                        autocomplete="off"
                        inputmode="text"
                        spellcheck="false"
                    />
                </div>
                <p id="auth-error" class="error-message"></p>
                <div class="form-actions" style="justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" id="register-btn">註冊新帳號</button>
                    <button type="submit" class="btn" id="login-btn">登入</button>
                </div>
            </form>
        </div>
    </div>

    


    <!-- 主應用區塊 -->
    <!-- <div id="app-container">
        <header class="app-bar">
            <h1>我的任務</h1>
            <div class="app-bar-user-info">
                <span id="user-email"></span>
                <button class="btn" id="add-task-btn"><i class="mdi mdi-plus"></i>新增任務</button>
                <button class="btn" id="export-tasks-btn"><i class="mdi mdi-download"></i>匯出任務</button>
                <button class="btn" id="logout-btn">登出</button>
            </div>
        </header>
    </div> -->
    <!-- 任務編輯/新增 Modal -->
    <div class="modal-overlay" id="task-modal-overlay">
        <div class="modal-content" id="task-form-container">
            <h2 id="form-title">新增任務</h2>
            <form id="task-form">
                <input type="hidden" id="task-id">
                <div class="form-group">
                    <label for="title">標題</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="due-date">到期日</label>
                    <input type="date" id="due-date" class="form-control">
                </div>
                <div class="form-group">
                    <label>描述</label>
                    <!-- HTML 編輯器 -->
                    <div style="border: 1px solid #bdbdbd; border-radius: 4px;">
                        <!-- HTML 編輯器工具列美化版 -->
                        <div style="background: #f5f5f5; padding: 4px 8px; border-bottom: 1px solid #e0e0e0; display: flex; align-items: center; gap: 6px;">
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('bold',false,null);" title="粗體"><b>B</b></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('italic',false,null);" title="斜體"><i>I</i></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('underline',false,null);" title="底線"><u>U</u></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('insertUnorderedList',false,null);" title="項目符號">•</button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('insertOrderedList',false,null);" title="編號">1.</button>
                            <!-- 字體大小 -->
                            <select id="font-size-select" style="margin-left:8px;padding:2px 6px;border-radius:4px;border:1px solid #bdbdbd;font-size:1em;" onchange="setFontSize(this.value)">
                                <option value="">字體大小</option>
                                <option value="1">極小</option>
                                <option value="2">小</option>
                                <option value="3">正常</option>
                                <option value="4">大</option>
                                <option value="5">較大</option>
                                <option value="6">特大</option>
                                <option value="7">最大</option>
                            </select>
                            <!-- 顏色區塊 -->
                            <div style="display:inline-flex;align-items:center;gap:4px;margin-left:8px;">
                                <!-- 三個快速顏色按鈕 -->
                                <button type="button" class="btn btn-secondary color-btn" style="background:transparent;border:none;box-shadow:none;padding:2px;" onclick="quickFontColor('#e53935')" title="紅色">
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#e53935;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <button type="button" class="btn btn-secondary color-btn" style="background:transparent;border:none;box-shadow:none;padding:2px;" onclick="quickFontColor('#222')" title="黑色">
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#222;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <button type="button" class="btn btn-secondary color-btn" style="background:transparent;border:none;box-shadow:none;padding:2px;" onclick="quickFontColor('#43a047')" title="綠色">
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#43a047;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <!-- 套用顏色按鈕 -->
                                <button type="button" class="btn btn-secondary" style="padding:2px 8px;display:inline-flex;align-items:center;gap:2px;margin-left:2px;" onclick="applyFontColor()" title="套用選取顏色到反白文字">
                                    <i class="mdi mdi-format-color-text" style="font-size:1.2em;color:var(--primary-color);vertical-align:middle;"></i>
                                </button>
                                <!-- 色盤 -->
                                <input
                                    type="color"
                                    id="font-color-picker"
                                    title="字體顏色"
                                    style="width:28px;height:28px;border:none;background:transparent;cursor:pointer;vertical-align:middle;margin-left:2px;"
                                    aria-label="選擇字體顏色">
                            </div>
                        </div>
                        <div id="description" class="form-control" contenteditable="true" rows="3" style="min-height:80px;outline:none;"></div>
                    </div>
                </div>
                 <div style="display: flex; gap: 16px;">
                    <div class="form-group" style="flex: 1;">
                        <label for="status">狀態</label>
                        <select id="status" class="form-control">
                            <option value="pending">待處理</option>
                            <option value="in-progress">進行中</option>
                            <option value="completed">已完成</option>
                        </select>
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label for="priority">優先級</label>
                        <select id="priority" class="form-control">
                            <option value="low">低</option>
                            <option value="medium">中</option>
                            <option value="high">高</option>
                        </select>
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">取消</button>
                    <button type="submit" class="btn" id="save-btn">
                        <span class="btn-text">儲存</span>
                        <i class="mdi mdi-loading" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
        // 將 contenteditable 的內容同步到 JS 表單
        // document.addEventListener('DOMContentLoaded', function() {
        //     const form = document.getElementById('task-form');
        //     if (form) {
        //         form.addEventListener('submit', function(e) {
        //             // 將 description 的 HTML 存到一個隱藏欄位或直接在 JS 取 innerHTML
        //             // 這裡不需要 textarea，直接用 contenteditable
        //         });
        //     }
        // });
    
        function setFontSize(size) {
            document.getElementById('description').focus();
            if (size) document.execCommand('fontSize', false, size);
        }
        function applyFontColor() {
            const color = document.getElementById('font-color-picker').value;
            document.getElementById('description').focus();
            if (color) document.execCommand('foreColor', false, color);
        }
        // 新增：快速套用指定顏色
        function quickFontColor(color) {
            document.getElementById('description').focus();
            if (color) document.execCommand('foreColor', false, color);
        }
    </script>
    <!-- 刪除確認 Modal -->
    <div class="modal-overlay" id="confirm-modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title">確認操作</h2>
            <p id="confirm-message">您確定要執行此操作嗎？</p>
            <div class="form-actions"><button type="button" class="btn btn-secondary" id="confirm-cancel-btn">取消</button><button type="button" class="btn" id="confirm-ok-btn">確定</button></div>
        </div>
    </div>
    <!-- Snackbar 提示 -->
    <div id="snackbar" class="snackbar"></div>

    <script type="module">
        /**
         * ApiService 類別
         * 職責：處理所有與後端 API 的通訊。
         */
        class ApiService {
            constructor(baseUrl) {
                this.baseUrl = baseUrl; // API 伺服器網址
                this.token = null;      // JWT Token
            }

            setToken(token) {
                this.token = token; // 設定 JWT Token
            }
            
            // 通用 fetch 方法，會自動帶入 token 與處理錯誤
            async _fetch(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                const response = await fetch(`${this.baseUrl}${endpoint}`, { ...options, headers });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.message || '發生未知錯誤');
                }

                if (response.status === 204) {
                    return null;
                }
                
                return response.json();
            }

            // --- Auth ---
            login(email, password) {
                return this._fetch('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            register(email, password) {
                 return this._fetch('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            // --- Tasks ---
            getTasks() { return this._fetch('/api/tasks'); }
            createTask(taskData) { return this._fetch('/api/tasks', { method: 'POST', body: JSON.stringify(taskData) }); }
            updateTask(taskId, taskData) { return this._fetch(`/api/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify(taskData) }); }
            // START MODIFICATION: 在 ApiService 中新增 updateTaskStatus 方法
            updateTaskStatus(taskId, status) { return this._fetch(`/api/tasks/${taskId}/status`, { method: 'PATCH',body: JSON.stringify({ status: status })}); }            
            // END MODIFICATION
            deleteTask(taskId) { return this._fetch(`/api/tasks/${taskId}`, { method: 'DELETE' }); }
        }

        /**
         * UIController 類別
         * 職責：管理所有 DOM 操作與 UI 狀態。
         */
        class UIController {
             constructor() {
                // 快速存取所有常用 DOM 元素
                this.elements = {
                    authContainer: document.getElementById('auth-container'),
                    appContainer: document.getElementById('app-container'),
                    userEmailDisplay: document.getElementById('user-email'),
                    authError: document.getElementById('auth-error'),
                    loginForm: document.getElementById('login-form'),
                    emailInput: document.getElementById('email'),
                    passwordInput: document.getElementById('password'),
                    loginBtn: document.getElementById('login-btn'),
                    registerBtn: document.getElementById('register-btn'),
                    taskSectionsContainer: document.getElementById('task-sections'),
                    modalOverlay: document.getElementById('task-modal-overlay'),
                    form: document.getElementById('task-form'),
                    formTitle: document.getElementById('form-title'),
                    taskIdInput: document.getElementById('task-id'),
                    titleInput: document.getElementById('title'),
                    descriptionInput: document.getElementById('description'),
                    statusInput: document.getElementById('status'),
                    priorityInput: document.getElementById('priority'),
                    saveBtn: document.getElementById('save-btn'),
                    snackbar: document.getElementById('snackbar'),
                    confirmModal: document.getElementById('confirm-modal-overlay'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmMessage: document.getElementById('confirm-message'),
                    confirmOkBtn: document.getElementById('confirm-ok-btn'),
                    confirmCancelBtn: document.getElementById('confirm-cancel-btn'),

                    // --- 新增：快取篩選元件 ---
                    searchInput: document.getElementById('search-input'),
                    priorityFilter: document.getElementById('priority-filter'),
                    // --- 新增：快取到期日輸入框 ---
                    dueDateInput: document.getElementById('due-date'),

                    // START MODIFICATION: 快取新 UI 元素
                    tasksView: document.getElementById('tasks-view'),
                    dashboardView: document.getElementById('dashboard-view'),
                    showTasksViewBtn: document.getElementById('show-tasks-view-btn'),
                    showDashboardViewBtn: document.getElementById('show-dashboard-view-btn'),
                    statusChartCanvas: document.getElementById('status-chart'),
                    priorityChartCanvas: document.getElementById('priority-chart'),
                    addTaskBtn: document.getElementById('add-task-btn'), // 快取新增任務按鈕
                    // END MODIFICATION

                    createdFrom: document.getElementById('created-from'),
                    createdTo: document.getElementById('created-to'),
                    
                    // START MODIFICATION: 快取新的 canvas 元素
                    monthlyVolumeChartCanvas: document.getElementById('monthly-volume-chart'),
                    dueTasksChartCanvas: document.getElementById('due-tasks-chart'),
                    // END MODIFICATION
                };
                this._resolveConfirm = null;
            }

            // START MODIFICATION: 新增切換視圖的 UI 邏輯
            switchView(viewToShow) {
                // 隱藏所有主視圖
                this.elements.tasksView.style.display = 'none';
                this.elements.dashboardView.style.display = 'none';
                
                // 顯示指定的視圖
                if (viewToShow === 'tasks') {
                    this.elements.tasksView.style.display = 'block';
                    this.elements.addTaskBtn.style.display = 'inline-flex'; // 顯示新增按鈕
                } else if (viewToShow === 'dashboard') {
                    this.elements.dashboardView.style.display = 'block';
                    this.elements.addTaskBtn.style.display = 'none'; // 隱藏新增按鈕
                }

                // 更新按鈕的 active 狀態
                this.elements.showTasksViewBtn.classList.toggle('active', viewToShow === 'tasks');
                this.elements.showDashboardViewBtn.classList.toggle('active', viewToShow === 'dashboard');
            }
            // END MODIFICATION


            // 設定刪除確認視窗的事件
            setupConfirmationModal() {
                this.elements.confirmCancelBtn.addEventListener('click', () => this.resolveConfirmation(false));
                this.elements.confirmOkBtn.addEventListener('click', () => this.resolveConfirmation(true));
            }

            // 顯示確認視窗，回傳 Promise
            showConfirmation(title, message) {
                return new Promise(resolve => {
                    this._resolveConfirm = resolve;
                    this.elements.confirmTitle.textContent = title;
                    this.elements.confirmMessage.textContent = message;
                    this.elements.confirmModal.classList.add('visible');
                });
            }

            // 關閉確認視窗
            resolveConfirmation(result) {
                if (this._resolveConfirm) {
                    this.elements.confirmModal.classList.remove('visible');
                    this._resolveConfirm(result);
                    this._resolveConfirm = null;
                }
            }

            // 產生單一任務卡片 DOM
            _createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'task-card';
                card.dataset.id = task.id;


                let dueDateHTML = '';
                let dateHighlightClass = '';
                let textHighlightClass = '';

                // 處理到期日顯示與高亮
                if (task.dueDate && task.status !== 'completed') {
                    const today = new Date();
                    today.setHours(0, 0, 0, 0); // 設定為今日零點，方便比較
                    const dueDate = new Date(task.dueDate);
                    dueDate.setHours(23, 59, 59, 999); // 包含當天

                    const diffTime = dueDate.getTime() - today.getTime();
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

                    if (diffDays < 0) {
                        dateHighlightClass = 'overdue';
                        textHighlightClass = 'overdue-text';
                    } else if (diffDays <= 3) {
                        dateHighlightClass = 'due-soon';
                        textHighlightClass = 'due-soon-text';
                    }
                    
                    if (dateHighlightClass) card.classList.add(dateHighlightClass);
                    
                    dueDateHTML = `<div class="due-date-display ${textHighlightClass}">
                                    <i class="mdi mdi-calendar-clock"></i>
                                    <span>${task.dueDate}</span>
                                 </div>`;
                }


                const priorityClass = `priority-${task.priority}`;
                // 狀態 class，去掉連字號
                const statusClass = `status-${task.status.replace('-', '')}`;
                // 狀態顯示文字
                const statusText = task.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());

                // 修正日期處理
                const rawDate = task.createdAt;
                
                let creationDate = 'N/A';
                if (rawDate) {
                    const d = new Date(rawDate);
                    if (!isNaN(d.getTime())) {
                        creationDate = d.toLocaleDateString();
                    }
                }

                const safeDescription = task.description || '';
                
                // 卡片內容
                card.innerHTML = `
                    <div class="task-card-header">
                        <h3>${this._escapeHTML(task.title)}</h3>
                        <div class="task-card-actions">
                            <i class="mdi mdi-pencil icon-btn" data-action="edit" title="編輯任務"></i>
                            <i class="mdi mdi-delete icon-btn" data-action="delete" title="刪除任務"></i>
                        </div>
                    </div>
                    <div class="task-description">${safeDescription}</div>
                    <div class="task-card-footer">
                        <div class="tags">
                            <span class="tag ${priorityClass}">${task.priority.toUpperCase()}</span>
                            <span class="tag ${statusClass}">${statusText}</span>
                        </div>
                        <div class="dates">
                            ${dueDateHTML}
                            <span class="creation-date">創建於: ${creationDate}</span>
                        </div>
                    </div>`;
                return card;
            }

            // 防止 XSS 攻擊
            _escapeHTML(str) {
                return str ? str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '';
            }

            // 開關任務編輯/新增 Modal
            toggleModal(show = false) {
                this.elements.modalOverlay.classList.toggle('visible', show);
            }

            // 顯示 Snackbar 提示
            showSnackbar(message) {
                this.elements.snackbar.textContent = message;
                this.elements.snackbar.classList.add('show');
                setTimeout(() => {
                    this.elements.snackbar.classList.remove('show');
                }, 3000);
            }

            // 填入表單資料（編輯用）
            fillForm(task) {
                this.elements.formTitle.textContent = '編輯任務';
                this.elements.taskIdInput.value = task.id;
                this.elements.titleInput.value = task.title;
                //this.elements.descriptionInput.value = task.description;
                this.elements.descriptionInput.innerHTML = task.description || '';
                this.elements.statusInput.value = task.status;
                this.elements.priorityInput.value = task.priority;
                this.elements.dueDateInput.value = task.dueDate || '';
            }

            // 重設表單（新增用）
            resetForm() {
                this.elements.formTitle.textContent = '新增任務';
                this.elements.form.reset();
                this.elements.taskIdInput.value = '';
                this.elements.descriptionInput.innerHTML = '';
                this.elements.dueDateInput.value = ''; // 確保日期也被清空
            }

            // 新增：獲取 description 內容的方法
            getDescriptionContent() {
                return this.elements.descriptionInput.innerHTML;
            }

            // 儲存按鈕 loading 狀態切換
            toggleButtonLoading(btn, isLoading) {
                const text = btn.querySelector('.btn-text');
                const icon = btn.querySelector('.mdi-loading');
                btn.disabled = isLoading;
                if (isLoading) {
                    btn.classList.add('loading');
                    if (text) text.style.display = 'none';
                    if (icon) icon.style.display = 'inline-block';
                } else {
                    btn.classList.remove('loading');
                    if (text) text.style.display = 'inline-block';
                    if (icon) icon.style.display = 'none';
                }
            }

            // 顯示/清除登入錯誤訊息
            showAuthError(message) { this.elements.authError.textContent = message; }
            clearAuthError() { this.elements.authError.textContent = ''; }
            // 顯示主畫面
            showApp(email) { this.elements.authContainer.style.display = 'none'; this.elements.appContainer.style.display = 'flex'; this.elements.userEmailDisplay.textContent = email; }
            // 顯示登入畫面
            showLogin() { this.elements.authContainer.style.display = 'flex'; this.elements.appContainer.style.display = 'none'; this.clearAuthError(); this.elements.loginForm.reset(); }
            
            // 摺疊/展開分區
            toggleSection(sectionBody, icon) {
                sectionBody.classList.toggle('collapsed');
                icon.textContent = sectionBody.classList.contains('collapsed') ? '►' : '▼';
            }
        }

        /**
         * App 類別
         * 職責：應用程式進入點，協調所有模組。
         */
        class App {
            constructor() {
                this.api = new ApiService('http://127.0.0.1:3000');
                this.ui = new UIController();
                this.allTasks = [];
                this.logoutTimer = null; // 新增
                // START MODIFICATION: 新增屬性以保存圖表實例和當前視圖
                this.currentView = 'tasks'; // 預設為任務列表
                this.statusChartInstance = null;
                this.priorityChartInstance = null;
                this.monthlyVolumeChartInstance = null;
                this.dueTasksChartInstance = null;
                // END MODIFICATION
                this._initializeApp();
            }

            // 初始化應用程式
            _initializeApp() {
                this.ui.setupConfirmationModal();
                this._bindAuthEvents();
                this._bindAppEvents();
                this._checkLoginStatus();
                // START MODIFICATION: 初始化拖放功能
                this._initializeDragAndDrop();
                // END MODIFICATION
            }

            // 解析 JWT，取得 payload
            _parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch {
                    return null;
                }
            }

            // 設定自動登出計時器
            _setAutoLogout(token) {
                if (this.logoutTimer) clearTimeout(this.logoutTimer);
                const payload = this._parseJwt(token);
                if (payload && payload.exp) {
                    const expMs = payload.exp * 1000;
                    const now = Date.now();
                    if (expMs > now) {
                        this.logoutTimer = setTimeout(() => {
                            this._handleSessionExpired();
                        }, expMs - now);
                    } else {
                        this._handleSessionExpired();
                    }
                }
            }

            // 處理 session 過期
            _handleSessionExpired() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                this.api.setToken(null);
                this.ui.showLogin();
                this.ui.showSnackbar('登入逾時，請重新登入。');
            }

            // 修改 _checkLoginStatus
            _checkLoginStatus() {
                const token = localStorage.getItem('authToken');
                const email = localStorage.getItem('userEmail');
                if (token && email) {
                    // 新增：檢查 token 是否過期
                    const payload = this._parseJwt(token);
                    if (!payload || !payload.exp || payload.exp * 1000 < Date.now()) {
                        this._handleSessionExpired();
                        return;
                    }
                    this.api.setToken(token);
                    this.ui.showApp(email);
                    this._setAutoLogout(token); // 新增
                    this.loadTasks();
                } else {
                    this.ui.showLogin();
                }
            }
            
            // 綁定登入/註冊事件
            _bindAuthEvents() {
                this.ui.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.ui.elements.registerBtn.addEventListener('click', (e) => this.handleRegister(e));
            }

            // 處理登入
            async handleLogin(e) {
                e.preventDefault();
                this.ui.clearAuthError();
                const email = this.ui.elements.emailInput.value;
                const password = this.ui.elements.passwordInput.value;
                try {
                    const data = await this.api.login(email, password);
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('userEmail', email);
                    this.api.setToken(data.accessToken);
                    this._setAutoLogout(data.accessToken); // 新增
                    this._checkLoginStatus();
                } catch (error) {
                    this.ui.showAuthError(error.message);
                }
            }

            // 處理註冊
            async handleRegister(e) {
                e.preventDefault();
                this.ui.clearAuthError();
                const email = this.ui.elements.emailInput.value;
                const password = this.ui.elements.passwordInput.value;
                try {
                    const data = await this.api.register(email, password);
                    this.ui.showSnackbar(data.message + ' 請立即登入。');
                    this.ui.elements.passwordInput.value = '';
                } catch (error) {
                    this.ui.showAuthError(error.message);
                }
            }

            // 修改登出按鈕事件
            _bindAppEvents() {
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userEmail');
                    this.api.setToken(null);
                    if (this.logoutTimer) clearTimeout(this.logoutTimer); // 新增
                    this.ui.showLogin();
                });
                
                // 新增任務按鈕
                document.getElementById('add-task-btn').addEventListener('click', () => { this.ui.resetForm(); this.ui.toggleModal(true); });
                
                // 新增：匯出任務按鈕
                // document.getElementById('export-tasks-btn').addEventListener('click', () => this.exportTasks());
                document.getElementById('export-tasks-btn').addEventListener('click', () => {
                    const element = document.getElementById('task-list-export');
                    if (!element) {
                        this.ui.showSnackbar('找不到任務列表區塊');
                        return;
                    }
                    html2pdf().from(element).set({
                        margin: 10,
                        filename: `tasks_${new Date().toISOString().slice(0,10)}.pdf`,
                        html2canvas: { scale: 2 }
                    }).save();
                });

                // 點擊 Modal 外部關閉
                this.ui.elements.modalOverlay.addEventListener('click', e => { if (e.target === this.ui.elements.modalOverlay) this.ui.toggleModal(false); });
                
                // 取消按鈕
                document.getElementById('cancel-btn').addEventListener('click', () => this.ui.toggleModal(false));
                
                // 表單提交
                this.ui.elements.form.addEventListener('submit', this.handleFormSubmit.bind(this));
                
                // 任務卡片事件（編輯、刪除）
                this.ui.elements.taskSectionsContainer.addEventListener('click', this.handleTaskListClick.bind(this));
                
                // 分區展開/收合
                this.ui.elements.taskSectionsContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.section-header');
                    if (!header) return;

                    const sectionName = header.dataset.section;
                    const sectionBody = document.getElementById(`section-${sectionName}`);
                    const icon = document.getElementById(`toggle-${sectionName}`);
                    
                    if (sectionBody && icon) {
                        this.ui.toggleSection(sectionBody, icon);
                    }
                });

                // ==========================================================
                // ================ 新增：綁定篩選事件 ================
                // ==========================================================
                this.ui.elements.searchInput.addEventListener('input', () => this._applyFiltersAndRender());
                this.ui.elements.priorityFilter.addEventListener('change', () => this._applyFiltersAndRender());
 
                // START MODIFICATION: 綁定視圖切換事件
                this.ui.elements.showTasksViewBtn.addEventListener('click', () => this.showView('tasks'));
                this.ui.elements.showDashboardViewBtn.addEventListener('click', () => this.showView('dashboard'));
                // END MODIFICATION


                this.ui.elements.createdFrom.addEventListener('change', () => this._applyFiltersAndRender());
                this.ui.elements.createdTo.addEventListener('change', () => this._applyFiltersAndRender());                
            }


            // START MODIFICATION: 新增視圖管理和圖表渲染方法
            /**
             * 顯示指定視圖並觸發對應的渲染
             * @param {'tasks' | 'dashboard'} viewName 
             */
            showView(viewName) {
                if (this.currentView === viewName) return; // 如果已經在當前視圖，則不動作
                
                this.currentView = viewName;
                this.ui.switchView(viewName);

                if (viewName === 'dashboard') {
                    this._renderDashboard();
                }
            }


            /**
             * 渲染儀表板上的所有圖表
             */
            _renderDashboard() {
                // Part 1. 處理狀態圖表
                const statusCounts = this.allTasks.reduce((acc, task) => {
                    acc[task.status] = (acc[task.status] || 0) + 1;
                    return acc;
                }, {});

                const statusData = {
                    labels: ['待處理 (Pending)', '進行中 (In Progress)', '已完成 (Completed)'],
                    datasets: [{
                        label: '任務數量',
                        data: [
                            statusCounts['pending'] || 0,
                            statusCounts['in-progress'] || 0,
                            statusCounts['completed'] || 0
                        ],
                        backgroundColor: [
                            getComputedStyle(document.documentElement).getPropertyValue('--status-pending-color'),
                            getComputedStyle(document.documentElement).getPropertyValue('--status-inprogress-color'),
                            getComputedStyle(document.documentElement).getPropertyValue('--status-completed-color')
                        ],
                        hoverOffset: 4
                    }]
                };

                // 建立或更新圖表
                if (this.statusChartInstance) this.statusChartInstance.destroy();
                this.statusChartInstance = new Chart(this.ui.elements.statusChartCanvas, {
                    type: 'pie',
                    data: statusData,
                });

                // Part 2. 處理優先級圖表
                const priorityCounts = this.allTasks.reduce((acc, task) => {
                    acc[task.priority] = (acc[task.priority] || 0) + 1;
                    return acc;
                }, {});

                const priorityData = {
                    labels: ['高 (High)', '中 (Medium)', '低 (Low)'],
                    datasets: [{
                        label: '任務數量',
                        data: [
                            priorityCounts['high'] || 0,
                            priorityCounts['medium'] || 0,
                            priorityCounts['low'] || 0
                        ],
                        backgroundColor: [
                           getComputedStyle(document.documentElement).getPropertyValue('--high-priority-color'),
                           getComputedStyle(document.documentElement).getPropertyValue('--medium-priority-color'),
                           getComputedStyle(document.documentElement).getPropertyValue('--low-priority-color')
                        ],
                        hoverOffset: 4
                    }]
                };

                if (this.priorityChartInstance) this.priorityChartInstance.destroy();
                this.priorityChartInstance = new Chart(this.ui.elements.priorityChartCanvas, {
                    type: 'doughnut',
                    data: priorityData,
                });


                // --- Part 3: 最近半年任務建立量 (折線圖) ---
                const sixMonthsAgo3 = new Date();
                sixMonthsAgo3.setMonth(sixMonthsAgo3.getMonth() - 5);
                sixMonthsAgo3.setDate(1);

                const monthlyLabels = [];
                const monthlyData = [];
                for (let i = 0; i < 6; i++) {
                    const month = new Date(sixMonthsAgo3);
                    month.setMonth(sixMonthsAgo3.getMonth() + i);
                    const label = month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2, '0');
                    monthlyLabels.push(label);
                    monthlyData.push(0);
                }

                this.allTasks.forEach(task => {
                    if (task.createdAt) {
                        const taskMonth = task.createdAt.slice(0, 7);
                        const index = monthlyLabels.indexOf(taskMonth);
                        if (index !== -1) {
                            monthlyData[index]++;
                        }
                    }
                });

                if (this.monthlyVolumeChartInstance) this.monthlyVolumeChartInstance.destroy();
                this.monthlyVolumeChartInstance = new Chart(this.ui.elements.monthlyVolumeChartCanvas, {
                    type: 'line',
                    data: {
                        labels: monthlyLabels,
                        datasets: [{
                            label: '新增任務數',
                            data: monthlyData,
                            fill: false,
                            borderColor: getComputedStyle(document.documentElement).getPropertyValue('--primary-color'),
                            tension: 0.1
                        }]
                    }
                });

                // START MODIFICATION: 更新第四張圖表的邏輯，改為「分組長條圖」

                // --- Part 4: 最近半年到期任務分析 (組合圖表：分組長條圖 + 折線圖) ---
                const sixMonthsAgo4 = new Date();
                sixMonthsAgo4.setMonth(sixMonthsAgo4.getMonth() - 5);
                sixMonthsAgo4.setDate(1);

                const taskAnalysisLabels = [];
                const onTimeData = new Array(6).fill(0);
                const lateData = new Array(6).fill(0);
                const overdueData = new Array(6).fill(0);
                const pendingData = new Array(6).fill(0);

                for (let i = 0; i < 6; i++) {
                    const month = new Date(sixMonthsAgo4);
                    month.setMonth(sixMonthsAgo4.getMonth() + i);
                    taskAnalysisLabels.push(month.getFullYear() + '-' + String(month.getMonth() + 1).padStart(2, '0'));
                }
                
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                this.allTasks.forEach(task => {
                    if (!task.dueDate) return;
                    
                    const dueDate = new Date(task.dueDate);
                    const createDate = new Date(task.createdAt);
                    const taskDueMonth = task.dueDate.slice(0, 7);
                    const taskCreatedAtMonth = task.createdAt.slice(0, 7);
                    const indexDue = taskAnalysisLabels.indexOf(taskDueMonth);
                    const indexCreatedAt = taskAnalysisLabels.indexOf(taskCreatedAtMonth);
                    var index = -1;
                    
                    if (indexDue === -1 && indexCreatedAt === -1) {
                        return;
                    } else if (indexDue !== -1) {
                        index = indexDue;
                    } else if (indexCreatedAt !== -1) {
                        index = indexCreatedAt;
                    } 
                    // 如果 index 是 -1，表示任務的到期月份或建立月份不在最近六個月內
                    if (index === -1) return; 

                    if (task.status === 'completed') {                        
                        const completedAt = task.completedAt ? new Date(task.completedAt) : today;
                        if (completedAt <= dueDate) {
                            onTimeData[index]++;
                        } else {
                            lateData[index]++;
                        }
                    } else {                        
                        if (dueDate < today) {
                            overdueData[index]++;
                        } else {                            
                            pendingData[index]++;
                        }
                    }
                });

                const totalData = new Array(6).fill(0);
                for (let i = 0; i < 6; i++) {
                    totalData[i] = onTimeData[i] + lateData[i] + overdueData[i] + pendingData[i];
                }

                if (this.dueTasksChartInstance) this.dueTasksChartInstance.destroy();
                this.dueTasksChartInstance = new Chart(this.ui.elements.dueTasksChartCanvas, {
                    type: 'bar',
                    data: {
                        labels: taskAnalysisLabels,
                        datasets: [
                            {
                                type: 'line',
                                label: '當月到期總數',
                                data: totalData,
                                borderColor: '#666666',
                                backgroundColor: '#666666',
                                fill: false,
                                tension: 0.1,
                                order: 0
                            },
                            {
                                label: '準時完成',
                                data: onTimeData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--status-completed-color'),
                                // stack: 'combined', // 移除 stack 屬性
                                order: 1
                            },
                            {
                                label: '逾期完成',
                                data: lateData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--medium-priority-color'),
                                // stack: 'combined', // 移除 stack 屬性
                                order: 1
                            },
                            {
                                label: '至今仍逾期',
                                data: overdueData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--overdue-color'),
                                // stack: 'combined', // 移除 stack 屬性
                                order: 1
                            },
                            {
                                label: '未到期 (處理中)',
                                data: pendingData,
                                backgroundColor: getComputedStyle(document.documentElement).getPropertyValue('--status-inprogress-color'),
                                // stack: 'combined', // 移除 stack 屬性
                                order: 1
                            }
                        ]
                    },
                    options: {
                        plugins: {
                            title: { display: true, text: '任務到期狀況分析' },
                            tooltip: { mode: 'index', intersect: false }
                        },
                        responsive: true,
                        // 核心設定：關閉堆疊效果
                        scales: {
                            x: { stacked: false }, // <--- 將 true 改為 false
                            y: { stacked: false, beginAtZero: true } // <--- 將 true 改為 false
                        }
                    }
                });
                // END MODIFICATION
            }
            /**
             * 在數據變更後，智能刷新當前視圖
             */
            _refreshCurrentView() {
                if (this.currentView === 'tasks') {
                    this._applyFiltersAndRender();
                } else if (this.currentView === 'dashboard') {
                    this._renderDashboard();
                }
            }
            // END MODIFICATION

            async loadTasks() {
                try {
                    this.allTasks = await this.api.getTasks();
                    this._refreshCurrentView(); // 使用新的刷新方法
                } catch (error) { /* ... */ }
            }

            async handleFormSubmit(event) {
                // ... [前半部邏輯不變] ...
                try {
                    // ... [API 呼叫不變] ...
                    await this.loadTasks(); // loadTasks 會自動刷新當前視圖
                } catch (error) { /* ... */ } 
                finally { /* ... */ }
            }
            
            _initializeDragAndDrop() {
                // ... onEnd 事件中 ...
                // onEnd: async (evt) => {
                //   try { ... } 
                //   finally {
                //     this._refreshCurrentView(); // 拖放結束後也使用新的刷新方法
                //   }
                // }
            }

            // START MODIFICATION: 新增 _initializeDragAndDrop 方法
            /**
             * 初始化 SortableJS 拖放功能
             */
            _initializeDragAndDrop() {
                const lists = document.querySelectorAll('.task-list');
                lists.forEach(list => {
                    new Sortable(list, {
                        group: 'tasks', // 讓所有列表可以互相拖放
                        animation: 150,
                        ghostClass: 'sortable-ghost', // 拖放時佔位元素的 class
                        dragClass: 'sortable-drag',   // 被拖曳元素的 class
                        onEnd: async (evt) => {
                            const { item, to, from } = evt;
                            const taskId = item.dataset.id;
                            
                            // 如果只是在同一個列表內排序，或沒有移動到新的列表，則不處理
                            if (from === to) { return; }

                            // 從目標列表的 ID 中解析出新的狀態
                            // e.g., 'section-in-progress' -> 'in-progress'
                            const newStatus = to.id.replace('section-', '');

                            // 找到被移動的任務
                            const task = this.allTasks.find(t => t.id == taskId);

                            if (task && task.status !== newStatus) {
                                // 建立要更新的資料
                                const originalStatus = task.status;
                                
                                // 樂觀更新 (Optimistic Update): 先在 UI 上更新，再發送 API
                                // 1. 先將卡片留在新的位置
                                // 2. 更新 allTasks 陣列中的資料
                                task.status = newStatus; 
                                
                                try {
                                    // 3. 發送 API 請求到後端
                                    await this.api.updateTaskStatus(taskId, newStatus);
                                    this.ui.showSnackbar(`任務狀態已更新為 "${newStatus}"`);
                                } catch (error) {
                                    // 4. 如果 API 失敗，復原 UI
                                    this.ui.showSnackbar(`更新失敗: ${error.message}`);
                                    // 將任務狀態改回來
                                    // task.status = from.id.replace('section-', '');
                                    task.status = originalStatus;
                                    // 將 DOM 元素移回原來的列表
                                    from.appendChild(item);
                                } finally {
                                    // 5. 無論成功或失敗，都重新渲染以確保資料一致性
                                    this._applyFiltersAndRender();
                                }
                            }
                        }
                    });
                });
            }
            // END MODIFICATION
            // 載入任務
            async loadTasks() {
                try {
                    this.allTasks  = await this.api.getTasks();
                    // this.renderTasksByStatus(this.allTasks ); // 使用統一的渲染方法
                    this._applyFiltersAndRender(); // 使用新的渲染入口方法
                } catch (error) {
                    this.ui.showSnackbar('載入任務失敗: ' + error.message);
                    if (error.message.toLowerCase().includes('unauthorized') || error.message.toLowerCase().includes('forbidden')) {
                        document.getElementById('logout-btn').click();
                    }
                }
            }
            
            // ============================================================
            // ================ 新增：篩選與渲染的入口方法 ================
            // ============================================================
            _applyFiltersAndRender() {
                const searchTerm = this.ui.elements.searchInput.value.toLowerCase();
                const priority = this.ui.elements.priorityFilter.value;
                // 新增：獲取到期日的值
                const createdFrom = this.ui.elements.createdFrom.value;
                const createdTo = this.ui.elements.createdTo.value;

                let filteredTasks = this.allTasks;

                // 1. 根據搜尋關鍵字篩選
                if (searchTerm) {
                    filteredTasks = filteredTasks.filter(task => 
                        task.title.toLowerCase().includes(searchTerm) ||
                        (task.description && task.description.toLowerCase().includes(searchTerm))
                    );
                }

                // 2. 根據優先級篩選
                if (priority !== 'all') {
                    filteredTasks = filteredTasks.filter(task => task.priority === priority);
                }

                // 3. 建立日區間
                if (createdFrom) {
                    const fromDate = new Date(createdFrom);
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.createdAt) return false;
                        const created = new Date(task.createdAt);
                        return created >= fromDate;
                    });
                }
                if (createdTo) {
                    const toDate = new Date(createdTo);
                    filteredTasks = filteredTasks.filter(task => {
                        if (!task.createdAt) return false;
                        const created = new Date(task.createdAt);
                        // 包含當天
                        toDate.setHours(23,59,59,999);
                        return created <= toDate;
                    });
                }
                // 4. 使用篩選後的結果進行渲染
                this.renderTasksByStatus(filteredTasks);
            }

            /**
             * 根據任務狀態分類並渲染任務
             */
            renderTasksByStatus(tasks) {
                const sections = {
                    'pending': document.getElementById('section-pending'),
                    'in-progress': document.getElementById('section-in-progress'),
                    'completed': document.getElementById('section-completed')
                };

                // 1. 先清空所有容器
                Object.values(sections).forEach(section => section.innerHTML = '');

                // 2. 將任務分類並使用 UIController 產生卡片 DOM 元素
                tasks.forEach(task => {
                    const taskCardElement = this.ui._createTaskCard(task);
                    const statusKey = task.status;
                    
                    if (sections[statusKey]) {
                        sections[statusKey].appendChild(taskCardElement);
                    }
                });

                // 3. 如果分類後容器是空的，顯示提示訊息
                Object.keys(sections).forEach(key => {
                    if (!sections[key].hasChildNodes()) {
                        sections[key].innerHTML = '<p style="color: #757575; padding: 16px; text-align: center;">此分類無任務</p>';
                    }
                });
            }

            // 表單送出（新增/編輯任務）
            async handleFormSubmit(event) {
                event.preventDefault();
                this.ui.toggleButtonLoading(this.ui.elements.saveBtn, true);
                const id = this.ui.elements.taskIdInput.value;
                const taskData = {
                    title: this.ui.elements.titleInput.value,
                    //description: this.ui.elements.descriptionInput.value,
                    description: this.ui.getDescriptionContent(),
                    status: this.ui.elements.statusInput.value,
                    priority: this.ui.elements.priorityInput.value,
                    // 新增：獲取到期日的值
                    dueDate: this.ui.elements.dueDateInput.value || null // 如果沒填，送出 null
                };
                // 驗證必填欄位
                if (!taskData.title) {
                    this.ui.showSnackbar('標題是必填欄位！');
                    this.ui.toggleButtonLoading(this.ui.elements.saveBtn, false);
                    return;
                }

                try {
                    if (id) {
                        await this.api.updateTask(id, taskData);
                        this.ui.showSnackbar('任務更新成功！');
                    } else {
                        await this.api.createTask(taskData);
                        this.ui.showSnackbar('任務新增成功！');
                    }
                    this.ui.toggleModal(false);
                    await this.loadTasks();
                } catch (error) {
                    this.ui.showSnackbar('操作失敗: ' + error.message);
                } finally {
                    this.ui.toggleButtonLoading(this.ui.elements.saveBtn, false);
                }
            }

            // 處理任務卡片上的點擊（編輯/刪除）
            handleTaskListClick(event) {
                const target = event.target;
                // 確保點擊的是圖示按鈕
                if (!target.classList.contains('icon-btn')) return;

                const action = target.dataset.action;
                const card = target.closest('.task-card');
                
                if (!action || !card) return;
                
                const id = card.dataset.id;
                if (action === 'edit') {
                    this.handleEditTask(id);
                } else if (action === 'delete') {
                    this.handleDeleteTask(id);
                }
            }

            // 編輯任務
            handleEditTask(id) {
                const task = this.allTasks.find(t => t.id == id);
                if (task) {
                    this.ui.fillForm(task);
                    this.ui.toggleModal(true);
                }
            }

            // 刪除任務
            async handleDeleteTask(id) {
                const confirmed = await this.ui.showConfirmation('刪除任務', '您確定要永久刪除這個任務嗎？');
                if (confirmed) {
                    try {
                        await this.api.deleteTask(id);
                        this.ui.showSnackbar('任務已刪除！');
                        await this.loadTasks();
                    } catch (error) {
                        this.ui.showSnackbar('刪除失敗: ' + error.message);
                    }
                }
            }

            // 新增：匯出任務功能
            exportTasks() {
                if (!this.allTasks || this.allTasks.length === 0) {
                    this.ui.showSnackbar('沒有任務可匯出');
                    return;
                }
                const dataStr = JSON.stringify(this.allTasks, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tasks_export_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.ui.showSnackbar('任務已匯出');
                
            }
        }



        // --- 應用程式初始化 ---
        document.addEventListener('DOMContentLoaded', function() {
          new App();
        });
    </script>

</body>
</html>
