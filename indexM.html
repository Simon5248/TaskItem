<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tasks 應用程式 (自架後端版)</title>
    <!-- 字型與圖示 -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@mdi/font/css/materialdesignicons.min.css" rel="stylesheet">
    <style>
        /* 主題色與全域樣式 */
        :root {
            --primary-color: #3f51b5; --accent-color: #ff4081; --text-color: #212121;
            --background-color: #f5f5f5; --surface-color: #ffffff; --high-priority-color: #f44336;
            --medium-priority-color: #ff9800; --low-priority-color: #4caf50; --error-color: #d32f2f;
        }
        body { font-family: 'Roboto', sans-serif; margin: 0; background-color: var(--background-color); color: var(--text-color); line-height: 1.6; overflow: hidden; }
        /* 登入區塊樣式 */
        #auth-container { display: flex; justify-content: center; align-items: center; height: 100vh; }
        #app-container { display: none; flex-direction: column; height: 100vh; }
        .login-card { background: var(--surface-color); padding: 32px; border-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); width: 100%; max-width: 400px; text-align: center; }
        .login-card h1 { margin-top: 0; color: var(--primary-color); }
        .login-card .form-group { margin-bottom: 20px; text-align: left; }
        .login-card label { display: block; margin-bottom: 8px; font-weight: 500; }
        .login-card .form-control { width: 100%; padding: 12px; border: 1px solid #bdbdbd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .login-card .error-message { color: var(--error-color); font-size: 0.8rem; margin-top: 4px; min-height: 1.2em; }
        /* App Bar 樣式 */
        .app-bar { background-color: var(--primary-color); color: white; padding: 0 24px; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 2px 4px rgba(0,0,0,0.2); height: 64px; flex-shrink: 0; }
        .app-bar h1 { font-size: 1.25rem; font-weight: 500; }
        .app-bar-user-info { display: flex; align-items: center; gap: 16px; }
        #user-email { font-size: 0.9rem; }
        /* 按鈕樣式 */
        .btn { background-color: var(--accent-color); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; text-transform: uppercase; font-weight: 500; display: inline-flex; align-items: center; gap: 8px; transition: all 0.3s ease; }
        .btn:hover { background-color: #e03571; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
        .btn.loading { cursor: not-allowed; background-color: #bdbdbd; }
        .btn.loading .mdi-loading { animation: spin 1s linear infinite; }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        #logout-btn { background-color: transparent; border: 1px solid white; }
        main { flex-grow: 1; padding: 24px; overflow-y: auto; }
        /* 任務卡片樣式 */
        .task-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 16px; }
        .task-card { background-color: var(--surface-color); border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); padding: 16px; display: flex; flex-direction: column; gap: 8px; transition: box-shadow 0.3s ease; }
        .task-card:hover { box-shadow: 0 3px 6px rgba(0,0,0,0.16), 0 3px 6px rgba(0,0,0,0.23); }
        .task-card-header { display: flex; justify-content: space-between; align-items: flex-start; }
        .task-card-header h3 { margin: 0; font-size: 1.1rem; font-weight: 500; }
        .task-card-actions { display: flex; gap: 8px; }
        .task-card-actions .icon-btn { color: #757575; cursor: pointer; transition: color 0.2s; }
        .task-card-actions .icon-btn:hover { color: var(--primary-color); }
        .task-card p { margin: 0; color: #616161; font-size: 0.9rem; word-break: break-word; }
        .task-card-footer { margin-top: 12px; display: flex; justify-content: space-between; align-items: center; font-size: 0.8rem; }
        .tags { display: flex; gap: 8px; flex-wrap: wrap; }
        .tag { padding: 4px 8px; border-radius: 12px; color: white; font-weight: 500; }
        .tag.priority-high { background-color: var(--high-priority-color); }
        .tag.priority-medium { background-color: var(--medium-priority-color); }
        .tag.priority-low { background-color: var(--low-priority-color); }
        .tag.status-pending { background-color: #757575; }
        .tag.status-inprogress { background-color: #1976d2; }
        .tag.status-completed { background-color: #43a047; }
        .creation-date { color: #9e9e9e; }
        /* Modal 樣式 */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; opacity: 0; visibility: hidden; transition: opacity 0.3s ease; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background-color: var(--surface-color); padding: 24px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 11px 15px -7px rgba(0,0,0,0.2), 0 24px 38px 3px rgba(0,0,0,0.14), 0 9px 46px 8px rgba(0,0,0,0.12); transform: scale(0.95); transition: transform 0.3s ease; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-content h2 { margin-top: 0; margin-bottom: 24px; }
        .form-group { margin-bottom: 16px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #616161; }
        .form-control { width: 100%; padding: 10px; border: 1px solid #bdbdbd; border-radius: 4px; font-size: 1rem; box-sizing: border-box; }
        .form-actions { margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px; }
        .btn-secondary { background-color: transparent; color: var(--primary-color); border: 1px solid #e0e0e0; }
        /* Snackbar 樣式 */
        .snackbar { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: #323232; color: white; padding: 14px 24px; border-radius: 4px; z-index: 2000; transition: bottom 0.5s ease-in-out; }
        .snackbar.show { bottom: 20px; }
        /* 任務分區樣式 */
        .task-section { margin-bottom: 20px; }
        .section-header { background: #fafafa; border: 1px solid #e0e0e0; color: var(--text-color); padding: 10px 16px; cursor: pointer; font-weight: 500; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; transition: background-color 0.2s; }
        .section-header:hover { background-color: #f0f0f0; }
        .section-body { padding-top: 16px; }
        .section-body.collapsed { display: none; }
    </style>
</head>
<body>
    <!-- 登入/註冊區塊 -->
    <div id="auth-container">
        <div class="login-card">
            <h1>任務管理系統</h1>
            <p>請使用您的 Email 登入或註冊</p>
            <form id="login-form" method="POST">
                <div class="form-group">
                    <label for="email">Email</label>
                    <input type="email" id="email" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="password">密碼 (最少6位數)</label>
                    <input
                        type="password"
                        id="password"
                        class="form-control"
                        required
                        minlength="6"
                        maxlength="64"
                        autocomplete="off"
                        inputmode="text"
                        spellcheck="false"
                    />
                </div>
                <p id="auth-error" class="error-message"></p>
                <div class="form-actions" style="justify-content: space-between;">
                    <button type="button" class="btn btn-secondary" id="register-btn">註冊新帳號</button>
                    <button type="submit" class="btn" id="login-btn">登入</button>
                </div>
            </form>
        </div>
    </div>
    <!-- 主應用區塊 -->
    <div id="app-container">
        <header class="app-bar">
            <h1>我的任務</h1>
            <div class="app-bar-user-info">
                <span id="user-email"></span>
                <button class="btn" id="logout-btn">登出</button>
                <button class="btn" id="add-task-btn"><i class="mdi mdi-plus"></i>新增任務</button>
                <!-- 新增匯出按鈕 -->
                <button class="btn" id="export-tasks-btn"><i class="mdi mdi-download"></i>匯出任務</button>
            </div>
        </header>
        <main>
            <div id="task-list-export">
                <!-- 任務分區（可收合） -->
                <div id="task-sections">
                    <div class="task-section">
                        <div class="section-header" data-section="pending">
                            待處理 (Pending) <span id="toggle-pending">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-pending"></div>
                    </div>
                    <div class="task-section">
                        <div class="section-header" data-section="in-progress">
                            進行中 (In Progress) <span id="toggle-in-progress">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-in-progress"></div>
                    </div>
                    <div class="task-section">
                        <div class="section-header" data-section="completed">
                            已完成 (Completed) <span id="toggle-completed">▼</span>
                        </div>
                        <div class="section-body task-list" id="section-completed"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    <!-- 任務編輯/新增 Modal -->
    <div class="modal-overlay" id="task-modal-overlay">
        <div class="modal-content" id="task-form-container">
            <h2 id="form-title">新增任務</h2>
            <form id="task-form">
                <input type="text" id="task-id">
                <div class="form-group">
                    <label for="title">標題</label>
                    <input type="text" id="title" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="description">描述</label>
                    <!-- HTML 編輯器 -->
                    <div style="border: 1px solid #bdbdbd; border-radius: 4px;">
                        <div style="background: #f5f5f5; padding: 4px; border-bottom: 1px solid #e0e0e0;">
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('bold',false,null);"><b>B</b></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('italic',false,null);"><i>I</i></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('underline',false,null);"><u>U</u></button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('insertUnorderedList',false,null);">•</button>
                            <button type="button" class="btn btn-secondary" style="padding:2px 6px;font-size:1em;" onclick="document.getElementById('description').focus();document.execCommand('insertOrderedList',false,null);">1.</button>
                            <!-- 字體大小 -->
                            <select id="font-size-select" style="margin-left:8px;" onchange="setFontSize(this.value)">
                                <option value="">字體大小</option>
                                <option value="1">極小</option>
                                <option value="2">小</option>
                                <option value="3">正常</option>
                                <option value="4">大</option>
                                <option value="5">較大</option>
                                <option value="6">特大</option>
                                <option value="7">最大</option>
                            </select>
                            <!-- 字體顏色選擇器與套用按鈕（美化版） -->
                            <div style="display:inline-flex;align-items:center;margin-left:8px;">
                                <!-- 三個快速顏色按鈕 -->
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    style="padding:2px 8px;margin-right:2px;background:transparent;border:none;box-shadow:none;"
                                    onclick="quickFontColor('#e53935')"
                                    title="紅色"
                                >
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#e53935;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    style="padding:2px 8px;margin-right:2px;background:transparent;border:none;box-shadow:none;"
                                    onclick="quickFontColor('#222')"
                                    title="黑色"
                                >
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#222;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    style="padding:2px 8px;margin-right:2px;background:transparent;border:none;box-shadow:none;"
                                    onclick="quickFontColor('#43a047')"
                                    title="綠色"
                                >
                                    <span style="display:inline-block;width:18px;height:18px;border-radius:3px;background:#43a047;border:1.5px solid #bdbdbd;"></span>
                                </button>
                                <!-- 原本的顏色套用按鈕與色盤 -->
                                <button
                                    type="button"
                                    class="btn btn-secondary"
                                    style="padding:2px 10px;font-size:1em;margin-left:4px;display:inline-flex;align-items:center;gap:4px;"
                                    onclick="applyFontColor()"
                                    title="套用選取顏色到反白文字"
                                >
                                    <i class="mdi mdi-format-color-text" style="font-size:1.2em;color:var(--primary-color);vertical-align:middle;"></i>
                                    <span style="font-size:0.95em;">套用</span>
                                </button>
                                <input
                                    type="color"
                                    id="font-color-picker"
                                    title="字體顏色"
                                    style="width:28px;height:28px;border:none;background:transparent;cursor:pointer;vertical-align:middle;"
                                    aria-label="選擇字體顏色">
                            </div>
                        </div>
                        <div id="description" class="form-control" contenteditable="true" rows="3" style="min-height:80px;outline:none;"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label for="status">狀態</label>
                    <select id="status" class="form-control">
                        <option value="pending">待處理</option>
                        <option value="in-progress">進行中</option>
                        <option value="completed">已完成</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="priority">優先級</label>
                    <select id="priority" class="form-control">
                        <option value="low">低</option>
                        <option value="medium">中</option>
                        <option value="high">高</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-btn">取消</button>
                    <button type="submit" class="btn" id="save-btn">
                        <span class="btn-text">儲存</span>
                        <i class="mdi mdi-loading" style="display: none;"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
    <script>
    // 將 contenteditable 的內容同步到 JS 表單
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('task-form');
        if (form) {
            form.addEventListener('submit', function(e) {
                // 將 description 的 HTML 存到一個隱藏欄位或直接在 JS 取 innerHTML
                // 這裡不需要 textarea，直接用 contenteditable
            });
        }
    });
    </script>
    <!-- 刪除確認 Modal -->
    <div class="modal-overlay" id="confirm-modal-overlay">
        <div class="modal-content">
            <h2 id="confirm-title">確認操作</h2>
            <p id="confirm-message">您確定要執行此操作嗎？</p>
            <div class="form-actions"><button type="button" class="btn btn-secondary" id="confirm-cancel-btn">取消</button><button type="button" class="btn" id="confirm-ok-btn">確定</button></div>
        </div>
    </div>
    <!-- Snackbar 提示 -->
    <div id="snackbar" class="snackbar"></div>

    <script type="module">
        /**
         * ApiService 類別
         * 職責：處理所有與後端 API 的通訊。
         */
        class ApiService {
            constructor(baseUrl) {
                this.baseUrl = baseUrl; // API 伺服器網址
                this.token = null;      // JWT Token
            }

            setToken(token) {
                this.token = token; // 設定 JWT Token
            }
            
            // 通用 fetch 方法，會自動帶入 token 與處理錯誤
            async _fetch(endpoint, options = {}) {
                const headers = { 'Content-Type': 'application/json', ...options.headers };
                if (this.token) {
                    headers['Authorization'] = `Bearer ${this.token}`;
                }

                const response = await fetch(`${this.baseUrl}${endpoint}`, { ...options, headers });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({ message: response.statusText }));
                    throw new Error(errorData.message || '發生未知錯誤');
                }

                if (response.status === 204) {
                    return null;
                }
                
                return response.json();
            }

            // --- Auth ---
            login(email, password) {
                return this._fetch('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            register(email, password) {
                 return this._fetch('/api/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ email, password })
                });
            }

            // --- Tasks ---
            getTasks() { return this._fetch('/api/tasks'); }
            createTask(taskData) { return this._fetch('/api/tasks', { method: 'POST', body: JSON.stringify(taskData) }); }
            updateTask(taskId, taskData) { return this._fetch(`/api/tasks/${taskId}`, { method: 'PUT', body: JSON.stringify(taskData) }); }
            deleteTask(taskId) { return this._fetch(`/api/tasks/${taskId}`, { method: 'DELETE' }); }
        }

        /**
         * UIController 類別
         * 職責：管理所有 DOM 操作與 UI 狀態。
         */
        class UIController {
             constructor() {
                // 快速存取所有常用 DOM 元素
                this.elements = {
                    authContainer: document.getElementById('auth-container'),
                    appContainer: document.getElementById('app-container'),
                    userEmailDisplay: document.getElementById('user-email'),
                    authError: document.getElementById('auth-error'),
                    loginForm: document.getElementById('login-form'),
                    emailInput: document.getElementById('email'),
                    passwordInput: document.getElementById('password'),
                    loginBtn: document.getElementById('login-btn'),
                    registerBtn: document.getElementById('register-btn'),
                    taskSectionsContainer: document.getElementById('task-sections'),
                    modalOverlay: document.getElementById('task-modal-overlay'),
                    form: document.getElementById('task-form'),
                    formTitle: document.getElementById('form-title'),
                    taskIdInput: document.getElementById('task-id'),
                    titleInput: document.getElementById('title'),
                    descriptionInput: document.getElementById('description'),
                    statusInput: document.getElementById('status'),
                    priorityInput: document.getElementById('priority'),
                    saveBtn: document.getElementById('save-btn'),
                    snackbar: document.getElementById('snackbar'),
                    confirmModal: document.getElementById('confirm-modal-overlay'),
                    confirmTitle: document.getElementById('confirm-title'),
                    confirmMessage: document.getElementById('confirm-message'),
                    confirmOkBtn: document.getElementById('confirm-ok-btn'),
                    confirmCancelBtn: document.getElementById('confirm-cancel-btn'),
                };
                this._resolveConfirm = null;
            }

            // 設定刪除確認視窗的事件
            setupConfirmationModal() {
                this.elements.confirmCancelBtn.addEventListener('click', () => this.resolveConfirmation(false));
                this.elements.confirmOkBtn.addEventListener('click', () => this.resolveConfirmation(true));
            }

            // 顯示確認視窗，回傳 Promise
            showConfirmation(title, message) {
                return new Promise(resolve => {
                    this._resolveConfirm = resolve;
                    this.elements.confirmTitle.textContent = title;
                    this.elements.confirmMessage.textContent = message;
                    this.elements.confirmModal.classList.add('visible');
                });
            }

            // 關閉確認視窗
            resolveConfirmation(result) {
                if (this._resolveConfirm) {
                    this.elements.confirmModal.classList.remove('visible');
                    this._resolveConfirm(result);
                    this._resolveConfirm = null;
                }
            }

            // 產生單一任務卡片 DOM
            _createTaskCard(task) {
                const card = document.createElement('div');
                card.className = 'task-card';
                card.dataset.id = task.id;

                const priorityClass = `priority-${task.priority}`;
                // 狀態 class，去掉連字號
                const statusClass = `status-${task.status.replace('-', '')}`;
                // 狀態顯示文字
                const statusText = task.status.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());

                // 修正日期處理
                const rawDate = task.createdAt;
                
                let creationDate = 'N/A';
                if (rawDate) {
                    const d = new Date(rawDate);
                    if (!isNaN(d.getTime())) {
                        creationDate = d.toLocaleDateString();
                    }
                }

                const safeDescription = task.description || '';
                
                // 卡片內容
                card.innerHTML = `
                    <div class="task-card-header">
                        <h3>${this._escapeHTML(task.title)}</h3>
                        <div class="task-card-actions">
                            <i class="mdi mdi-pencil icon-btn" data-action="edit" title="編輯任務"></i>
                            <i class="mdi mdi-delete icon-btn" data-action="delete" title="刪除任務"></i>
                        </div>
                    </div>
                    <div class="task-description">${safeDescription}</div>
                    <div class="task-card-footer">
                        <div class="tags">
                            <span class="tag ${priorityClass}">${task.priority.toUpperCase()}</span>
                            <span class="tag ${statusClass}">${statusText}</span>
                        </div>
                        <span class="creation-date">${creationDate}</span>
                    </div>`;
                return card;
            }

            // 防止 XSS 攻擊
            _escapeHTML(str) {
                return str ? str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#039;') : '';
            }

            // 開關任務編輯/新增 Modal
            toggleModal(show = false) {
                this.elements.modalOverlay.classList.toggle('visible', show);
            }

            // 顯示 Snackbar 提示
            showSnackbar(message) {
                this.elements.snackbar.textContent = message;
                this.elements.snackbar.classList.add('show');
                setTimeout(() => {
                    this.elements.snackbar.classList.remove('show');
                }, 3000);
            }

            // 填入表單資料（編輯用）
            fillForm(task) {
                this.elements.formTitle.textContent = '編輯任務';
                this.elements.taskIdInput.value = task.id;
                this.elements.titleInput.value = task.title;
                //this.elements.descriptionInput.value = task.description;
                this.elements.descriptionInput.innerHTML = task.description || '';
                this.elements.statusInput.value = task.status;
                this.elements.priorityInput.value = task.priority;
            }

            // 重設表單（新增用）
            resetForm() {
                this.elements.formTitle.textContent = '新增任務';
                this.elements.form.reset();
                this.elements.taskIdInput.value = '';
                this.elements.descriptionInput.innerHTML = '';
            }

            // 新增：獲取 description 內容的方法
            getDescriptionContent() {
                return this.elements.descriptionInput.innerHTML;
            }

            // 儲存按鈕 loading 狀態切換
            toggleButtonLoading(btn, isLoading) {
                const text = btn.querySelector('.btn-text');
                const icon = btn.querySelector('.mdi-loading');
                btn.disabled = isLoading;
                if (isLoading) {
                    btn.classList.add('loading');
                    if (text) text.style.display = 'none';
                    if (icon) icon.style.display = 'inline-block';
                } else {
                    btn.classList.remove('loading');
                    if (text) text.style.display = 'inline-block';
                    if (icon) icon.style.display = 'none';
                }
            }

            // 顯示/清除登入錯誤訊息
            showAuthError(message) { this.elements.authError.textContent = message; }
            clearAuthError() { this.elements.authError.textContent = ''; }
            // 顯示主畫面
            showApp(email) { this.elements.authContainer.style.display = 'none'; this.elements.appContainer.style.display = 'flex'; this.elements.userEmailDisplay.textContent = email; }
            // 顯示登入畫面
            showLogin() { this.elements.authContainer.style.display = 'flex'; this.elements.appContainer.style.display = 'none'; this.clearAuthError(); this.elements.loginForm.reset(); }
            
            // 摺疊/展開分區
            toggleSection(sectionBody, icon) {
                sectionBody.classList.toggle('collapsed');
                icon.textContent = sectionBody.classList.contains('collapsed') ? '►' : '▼';
            }
        }

        /**
         * App 類別
         * 職責：應用程式進入點，協調所有模組。
         */
        class App {
            constructor() {
                this.api = new ApiService('http://127.0.0.1:3000');
                this.ui = new UIController();
                this.tasks = [];
                this.logoutTimer = null; // 新增
                this._initializeApp();
            }

            // 初始化應用程式
            _initializeApp() {
                this.ui.setupConfirmationModal();
                this._bindAuthEvents();
                this._bindAppEvents();
                this._checkLoginStatus();
            }

            // 解析 JWT，取得 payload
            _parseJwt(token) {
                try {
                    const base64Url = token.split('.')[1];
                    const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
                    const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
                        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
                    }).join(''));
                    return JSON.parse(jsonPayload);
                } catch {
                    return null;
                }
            }

            // 設定自動登出計時器
            _setAutoLogout(token) {
                if (this.logoutTimer) clearTimeout(this.logoutTimer);
                const payload = this._parseJwt(token);
                if (payload && payload.exp) {
                    const expMs = payload.exp * 1000;
                    const now = Date.now();
                    if (expMs > now) {
                        this.logoutTimer = setTimeout(() => {
                            this._handleSessionExpired();
                        }, expMs - now);
                    } else {
                        this._handleSessionExpired();
                    }
                }
            }

            // 處理 session 過期
            _handleSessionExpired() {
                localStorage.removeItem('authToken');
                localStorage.removeItem('userEmail');
                this.api.setToken(null);
                this.ui.showLogin();
                this.ui.showSnackbar('登入逾時，請重新登入。');
            }

            // 修改 _checkLoginStatus
            _checkLoginStatus() {
                const token = localStorage.getItem('authToken');
                const email = localStorage.getItem('userEmail');
                if (token && email) {
                    // 新增：檢查 token 是否過期
                    const payload = this._parseJwt(token);
                    if (!payload || !payload.exp || payload.exp * 1000 < Date.now()) {
                        this._handleSessionExpired();
                        return;
                    }
                    this.api.setToken(token);
                    this.ui.showApp(email);
                    this._setAutoLogout(token); // 新增
                    this.loadTasks();
                } else {
                    this.ui.showLogin();
                }
            }
            
            // 綁定登入/註冊事件
            _bindAuthEvents() {
                this.ui.elements.loginForm.addEventListener('submit', (e) => this.handleLogin(e));
                this.ui.elements.registerBtn.addEventListener('click', (e) => this.handleRegister(e));
            }

            // 處理登入
            async handleLogin(e) {
                e.preventDefault();
                this.ui.clearAuthError();
                const email = this.ui.elements.emailInput.value;
                const password = this.ui.elements.passwordInput.value;
                try {
                    const data = await this.api.login(email, password);
                    localStorage.setItem('authToken', data.accessToken);
                    localStorage.setItem('userEmail', email);
                    this.api.setToken(data.accessToken);
                    this._setAutoLogout(data.accessToken); // 新增
                    this._checkLoginStatus();
                } catch (error) {
                    this.ui.showAuthError(error.message);
                }
            }

            // 處理註冊
            async handleRegister(e) {
                e.preventDefault();
                this.ui.clearAuthError();
                const email = this.ui.elements.emailInput.value;
                const password = this.ui.elements.passwordInput.value;
                try {
                    const data = await this.api.register(email, password);
                    this.ui.showSnackbar(data.message + ' 請立即登入。');
                    this.ui.elements.passwordInput.value = '';
                } catch (error) {
                    this.ui.showAuthError(error.message);
                }
            }

            // 修改登出按鈕事件
            _bindAppEvents() {
                document.getElementById('logout-btn').addEventListener('click', () => {
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('userEmail');
                    this.api.setToken(null);
                    if (this.logoutTimer) clearTimeout(this.logoutTimer); // 新增
                    this.ui.showLogin();
                });
                
                // 新增任務按鈕
                document.getElementById('add-task-btn').addEventListener('click', () => { this.ui.resetForm(); this.ui.toggleModal(true); });
                
                // 新增：匯出任務按鈕
                // document.getElementById('export-tasks-btn').addEventListener('click', () => this.exportTasks());
                document.getElementById('export-tasks-btn').addEventListener('click', () => {
                    const element = document.getElementById('task-list-export');
                    if (!element) {
                        this.ui.showSnackbar('找不到任務列表區塊');
                        return;
                    }
                    html2pdf().from(element).set({
                        margin: 10,
                        filename: `tasks_${new Date().toISOString().slice(0,10)}.pdf`,
                        html2canvas: { scale: 2 }
                    }).save();
                });

                // 點擊 Modal 外部關閉
                this.ui.elements.modalOverlay.addEventListener('click', e => { if (e.target === this.ui.elements.modalOverlay) this.ui.toggleModal(false); });
                
                // 取消按鈕
                document.getElementById('cancel-btn').addEventListener('click', () => this.ui.toggleModal(false));
                
                // 表單提交
                this.ui.elements.form.addEventListener('submit', this.handleFormSubmit.bind(this));
                
                // 任務卡片事件（編輯、刪除）
                this.ui.elements.taskSectionsContainer.addEventListener('click', this.handleTaskListClick.bind(this));
                
                // 分區展開/收合
                this.ui.elements.taskSectionsContainer.addEventListener('click', (e) => {
                    const header = e.target.closest('.section-header');
                    if (!header) return;

                    const sectionName = header.dataset.section;
                    const sectionBody = document.getElementById(`section-${sectionName}`);
                    const icon = document.getElementById(`toggle-${sectionName}`);
                    
                    if (sectionBody && icon) {
                        this.ui.toggleSection(sectionBody, icon);
                    }
                });
            }
            
            // 載入任務
            async loadTasks() {
                try {
                    this.tasks = await this.api.getTasks();
                    this.renderTasksByStatus(this.tasks); // 使用統一的渲染方法
                } catch (error) {
                    this.ui.showSnackbar('載入任務失敗: ' + error.message);
                    if (error.message.toLowerCase().includes('unauthorized') || error.message.toLowerCase().includes('forbidden')) {
                        document.getElementById('logout-btn').click();
                    }
                }
            }
            
            /**
             * 根據任務狀態分類並渲染任務
             */
            renderTasksByStatus(tasks) {
                const sections = {
                    'pending': document.getElementById('section-pending'),
                    'in-progress': document.getElementById('section-in-progress'),
                    'completed': document.getElementById('section-completed')
                };

                // 1. 先清空所有容器
                Object.values(sections).forEach(section => section.innerHTML = '');

                // 2. 將任務分類並使用 UIController 產生卡片 DOM 元素
                tasks.forEach(task => {
                    const taskCardElement = this.ui._createTaskCard(task);
                    const statusKey = task.status;
                    
                    if (sections[statusKey]) {
                        sections[statusKey].appendChild(taskCardElement);
                    }
                });

                // 3. 如果分類後容器是空的，顯示提示訊息
                Object.keys(sections).forEach(key => {
                    if (!sections[key].hasChildNodes()) {
                        sections[key].innerHTML = '<p style="color: #757575; padding: 16px; text-align: center;">此分類無任務</p>';
                    }
                });
            }

            // 表單送出（新增/編輯任務）
            async handleFormSubmit(event) {
                event.preventDefault();
                this.ui.toggleButtonLoading(this.ui.elements.saveBtn, true);
                const id = this.ui.elements.taskIdInput.value;
                const taskData = {
                    title: this.ui.elements.titleInput.value,
                    //description: this.ui.elements.descriptionInput.value,
                    description: this.ui.getDescriptionContent(),
                    status: this.ui.elements.statusInput.value,
                    priority: this.ui.elements.priorityInput.value
                };
                try {
                    if (id) {
                        await this.api.updateTask(id, taskData);
                        this.ui.showSnackbar('任務更新成功！');
                    } else {
                        await this.api.createTask(taskData);
                        this.ui.showSnackbar('任務新增成功！');
                    }
                    this.ui.toggleModal(false);
                    await this.loadTasks();
                } catch (error) {
                    this.ui.showSnackbar('操作失敗: ' + error.message);
                } finally {
                    this.ui.toggleButtonLoading(this.ui.elements.saveBtn, false);
                }
            }

            // 處理任務卡片上的點擊（編輯/刪除）
            handleTaskListClick(event) {
                const target = event.target;
                // 確保點擊的是圖示按鈕
                if (!target.classList.contains('icon-btn')) return;

                const action = target.dataset.action;
                const card = target.closest('.task-card');
                
                if (!action || !card) return;
                
                const id = card.dataset.id;
                if (action === 'edit') {
                    this.handleEditTask(id);
                } else if (action === 'delete') {
                    this.handleDeleteTask(id);
                }
            }

            // 編輯任務
            handleEditTask(id) {
                const task = this.tasks.find(t => t.id == id);
                if (task) {
                    this.ui.fillForm(task);
                    this.ui.toggleModal(true);
                }
            }

            // 刪除任務
            async handleDeleteTask(id) {
                const confirmed = await this.ui.showConfirmation('刪除任務', '您確定要永久刪除這個任務嗎？');
                if (confirmed) {
                    try {
                        await this.api.deleteTask(id);
                        this.ui.showSnackbar('任務已刪除！');
                        await this.loadTasks();
                    } catch (error) {
                        this.ui.showSnackbar('刪除失敗: ' + error.message);
                    }
                }
            }

            // 新增：匯出任務功能
            exportTasks() {
                if (!this.tasks || this.tasks.length === 0) {
                    this.ui.showSnackbar('沒有任務可匯出');
                    return;
                }
                const dataStr = JSON.stringify(this.tasks, null, 2);
                const blob = new Blob([dataStr], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tasks_export_${new Date().toISOString().slice(0,10)}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.ui.showSnackbar('任務已匯出');
                
            }
        }


        // 額外建議：加入 CSS 樣式來美化 description 顯示
        const additionalCSS = `
        /* 任務描述區域樣式 */
        .task-description {
            margin: 8px 0;
            color: #616161;
            font-size: 0.9rem;
            word-break: break-word;
            line-height: 1.4;
        }

        .task-description b, .task-description strong {
            font-weight: 600;
            color: #424242;
        }

        .task-description i, .task-description em {
            font-style: italic;
        }

        .task-description u {
            text-decoration: underline;
        }

        .task-description ul, .task-description ol {
            margin: 4px 0 4px 20px;
            padding: 0;
        }

        .task-description li {
            margin: 2px 0;
        }

        /* contenteditable 編輯器樣式改進 */
        #description {
            min-height: 80px;
            outline: none;
            padding: 10px;
            line-height: 1.4;
        }

        #description:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(63, 81, 181, 0.2);
        }

        #description ul, #description ol {
            margin: 8px 0 8px 20px;
            padding: 0;
        }

        #description li {
            margin: 4px 0;
        }
        `;

        // 將額外的 CSS 加入到頁面
        const style = document.createElement('style');
        style.textContent = additionalCSS;
        document.head.appendChild(style);


        // --- 應用程式初始化 ---
        document.addEventListener('DOMContentLoaded', function() {
          new App();
        });
    </script>
    <!-- 請加在 </body> 前，或 type="module" 之前 -->
    <script>
    function setFontSize(size) {
        document.getElementById('description').focus();
        if (size) document.execCommand('fontSize', false, size);
    }
    function applyFontColor() {
        const color = document.getElementById('font-color-picker').value;
        document.getElementById('description').focus();
        if (color) document.execCommand('foreColor', false, color);
    }
    // 新增：快速套用指定顏色
    function quickFontColor(color) {
        document.getElementById('description').focus();
        if (color) document.execCommand('foreColor', false, color);
    }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>
